# حل مشکل تخفیف و پرینت فاکتور

## مشکل
خطای ActiveX threading زمانی رخ می‌دهد که تخفیف به اندازه قیمت فاکتور اعمال می‌شود و مبلغ نهایی صفر یا منفی می‌شود.

## علت مشکل
1. **تخفیف بیش از حد**: وقتی تخفیف از مبلغ کل بیشتر می‌شود، مبلغ نهایی منفی می‌شود
2. **عدم اعتبارسنجی**: سیستم قبلاً تخفیف‌های بیش از حد را کنترل نمی‌کرد
3. **مشکلات ActiveX**: پرینت فاکتورهای با مبلغ صفر ممکن است باعث مشکلات threading شود

## راه‌حل‌های پیاده‌سازی شده

### 1. InvoiceValidationHelper
- اعتبارسنجی کامل فاکتورها قبل از ذخیره و پرینت
- بررسی تخفیف‌های بیش از حد
- محاسبه مجدد مبالغ برای اطمینان از صحت

### 2. SafeInvoicePrinter
- پرینت ایمن فاکتورها با استفاده از STA threads
- اعتبارسنجی قبل از پرینت
- نمایش خلاصه فاکتور قبل از پرینت

### 3. بهبود محاسبات
- اطمینان از عدم منفی بودن مبلغ نهایی
- تغییر رنگ مبلغ نهایی در صورت صفر بودن
- مدیریت خطاهای محاسباتی

## ویژگی‌های جدید

### InvoiceValidationHelper
```csharp
// اعتبارسنجی فاکتور فروش
var (isValid, errorMessage) = InvoiceValidationHelper.ValidateSaleInvoice(sale);

// محاسبه مجدد مبالغ
InvoiceValidationHelper.RecalculateSaleAmounts(sale);

// نمایش خلاصه فاکتور
var summary = InvoiceValidationHelper.GetInvoiceSummary(sale);
```

### SafeInvoicePrinter
```csharp
// پرینت ایمن فاکتور فروش
SafeInvoicePrinter.PrintSaleInvoice(sale);

// پرینت ایمن فاکتور خرید
SafeInvoicePrinter.PrintPurchaseInvoice(purchase);

// نمایش پیش‌نمایش فاکتور
SafeInvoicePrinter.ShowInvoicePreview(sale);
```

## تغییرات اعمال شده

### فایل‌های جدید:
1. `InvoiceValidationHelper.cs` - ابزار اعتبارسنجی فاکتور
2. `SafeInvoicePrinter.cs` - ابزار پرینت ایمن فاکتور

### فایل‌های تغییر یافته:
1. `AddEditSaleForm.cs` - بهبود محاسبات و اعتبارسنجی
2. `SalesForm.cs` - استفاده از SafeInvoicePrinter

## قوانین جدید اعتبارسنجی

### محدودیت‌های تخفیف:
- تخفیف آیتم‌ها نمی‌تواند از قیمت کل آیتم بیشتر باشد
- مجموع تخفیف‌ها نمی‌تواند از مبلغ کل فاکتور بیشتر باشد
- مبلغ نهایی نمی‌تواند منفی باشد

### محاسبات خودکار:
- در صورت منفی شدن مبلغ نهایی، به صفر تبدیل می‌شود
- رنگ مبلغ نهایی در صورت صفر بودن به نارنجی تغییر می‌کند
- محاسبات مجدد قبل از ذخیره و پرینت

## نحوه استفاده

### برای کاربران:
1. هنگام اعمال تخفیف، سیستم به طور خودکار محدودیت‌ها را اعمال می‌کند
2. اگر تخفیف بیش از حد باشد، پیام خطا نمایش داده می‌شود
3. مبلغ نهایی هرگز منفی نمی‌شود
4. پرینت فاکتور با روش‌های ایمن انجام می‌شود

### برای توسعه‌دهندگان:
```csharp
// اعتبارسنجی قبل از ذخیره
var (isValid, errorMessage) = InvoiceValidationHelper.ValidateSaleInvoice(sale);
if (!isValid) {
    // نمایش خطا
    return;
}

// پرینت ایمن
SafeInvoicePrinter.PrintSaleInvoice(sale);
```

## سناریوهای پشتیبانی شده

### سناریو 1: تخفیف عادی
- تخفیف کمتر از مبلغ کل
- مبلغ نهایی مثبت
- پرینت عادی

### سناریو 2: تخفیف کامل
- تخفیف برابر با مبلغ کل
- مبلغ نهایی صفر
- پرینت با نمایش هشدار

### سناریو 3: تخفیف بیش از حد
- تخفیف بیشتر از مبلغ کل
- نمایش خطا و جلوگیری از ذخیره
- مبلغ نهایی به صفر تبدیل می‌شود

## نکات مهم
- همیشه از `SafeInvoicePrinter` برای پرینت استفاده کنید
- قبل از ذخیره فاکتور، از `InvoiceValidationHelper` استفاده کنید
- مبلغ نهایی هرگز منفی نمی‌شود
- سیستم به طور خودکار محدودیت‌های تخفیف را اعمال می‌کند

## عیب‌یابی
اگر هنوز مشکل دارید:
1. بررسی کنید که تخفیف از مبلغ کل بیشتر نباشد
2. از دکمه "پیش‌نمایش فاکتور" استفاده کنید
3. بررسی کنید که تمام آیتم‌ها قیمت مثبت داشته باشند
4. از روش "پرینت مستقیم" استفاده کنید 